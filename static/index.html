<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Conda ç¯å¢ƒç®¡ç†</title>
    <style>
        :root {
            --primary: #4e73df;
            --success: #28a745;
            --danger: #dc3545;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f7fb; color: #333; padding: 20px; line-height: 1.6; }
        .page-header { text-align: center; margin-bottom: 24px; }
        .page-header h1 { color: var(--primary); margin-bottom: 8px; }
        .container { max-width: 1200px; margin: 0 auto; display: flex; gap: 24px; }
        .main-content { flex: 2; display: flex; flex-direction: column; gap: 24px; }
        .log-sidebar { flex: 1; min-width: 300px; align-self: flex-start; }
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; }
        input, select, button { padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; width: 100%; }
        .btn { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: 600; transition: opacity 0.2s; width: auto; }
        .btn:hover { opacity: 0.9; }
        .btn-danger { background: var(--danger); }
        .btn-success { background: var(--success); }
        .env-list { list-style: none; }
        .env-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .env-item:last-child { border-bottom: none; }
        .env-name { font-weight: 600; font-size: 16px; }
        .env-version { color: var(--gray); font-size: 14px; }
        .actions { display: flex; gap: 8px; }
        .log-container { height: 420px; overflow-y: auto; background: #2d2d2d; color: #f8f8f2; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 13px; }
        .log-entry { margin-bottom: 6px; word-break: break-word; }
        .log-error { color: #ff5555; }
        .log-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        @media (max-width: 900px) {
            .container { flex-direction: column; }
            .log-sidebar { min-width: auto; align-self: stretch; }
            .log-container { height: 180px; }
        }
    </style>
</head>
<body>
    <div class="page-header">
        <h1>ğŸ“¦ Conda ç¯å¢ƒç®¡ç†</h1>
        <p>åˆ›å»ºã€å…‹éš†ã€æŸ¥çœ‹ã€åˆ é™¤å’Œå¯¼å‡ºä½ çš„ Python è™šæ‹Ÿç¯å¢ƒ</p>
    </div>

    <div class="container">
        <div class="main-content">
            <!-- åˆ›å»ºç¯å¢ƒ -->
            <div class="card">
                <h2>âœ¨ åˆ›å»ºæ–°ç¯å¢ƒ</h2>
                <div class="form-group">
                    <label for="envName">ç¯å¢ƒåç§°</label>
                    <input type="text" id="envName" placeholder="ä¾‹å¦‚ï¼šmy_project" />
                </div>
                <div class="form-group">
                    <label for="pythonVersion">Python ç‰ˆæœ¬</label>
                    <select id="pythonVersion">
                        <option value="3.8">3.8</option><option value="3.9">3.9</option><option value="3.10">3.10</option>
                        <option value="3.11">3.11</option><option value="3.12" selected>3.12</option><option value="3.13">3.13</option>
                    </select>
                </div>
                <button class="btn" onclick="createEnv()">ğŸš€ åˆ›å»ºç¯å¢ƒ</button>
            </div>

            <!-- å…‹éš†ç¯å¢ƒ -->
            <div class="card">
                <h2>ğŸ”„ å…‹éš†ç¯å¢ƒ</h2>
                <div class="form-group">
                    <label for="sourceEnv">æºç¯å¢ƒ</label>
                    <select id="sourceEnv">
                        <option value="">åŠ è½½ä¸­...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="newEnvName">æ–°ç¯å¢ƒåç§°</label>
                    <input type="text" id="newEnvName" placeholder="ä¾‹å¦‚ï¼šmy_project_copy" />
                </div>
                <button class="btn" onclick="cloneEnv()">ğŸ“‹ å…‹éš†ç¯å¢ƒ</button>
            </div>

            <!-- ç¯å¢ƒåˆ—è¡¨ -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2>ğŸ“‹ å·²æœ‰ç¯å¢ƒ</h2>
                    <div>
                        <button class="btn" style="padding: 6px 12px; font-size: 14px;" onclick="loadEnvs()">ğŸ”„ åˆ·æ–°</button>
                        <button class="btn btn-success" style="padding: 6px 12px; font-size: 14px; margin-left: 8px;" onclick="exportEnv()">ğŸ“¦ å¯¼å‡ºYML</button>
                    </div>
                </div>
                <ul id="envList" class="env-list">
                    <li>åŠ è½½ä¸­...</li>
                </ul>
            </div>
        </div>

        <!-- æ—¥å¿—ä¾§è¾¹æ  -->
        <div class="log-sidebar">
            <div class="card">
                <div class="log-header">
                    <h2>ğŸ“œ æ“ä½œæ—¥å¿—</h2>
                    <button class="btn" style="padding: 4px 10px; font-size: 12px;" onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©º</button>
                </div>
                <div id="logContainer" class="log-container"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        // åŠ è½½ç¯å¢ƒåˆ—è¡¨ï¼ˆåŒæ—¶æ›´æ–°å…‹éš†çš„æºç¯å¢ƒä¸‹æ‹‰æ¡†ï¼‰
        async function loadEnvs() {
            try {
                const res = await fetch(`${API_BASE}/envs`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const envs = await res.json();
                const list = document.getElementById('envList');
                const sourceEnvSelect = document.getElementById('sourceEnv');

                // æ›´æ–°ç¯å¢ƒåˆ—è¡¨
                if (envs.length === 0) {
                    list.innerHTML = '<li>æš‚æ— ç¯å¢ƒ</li>';
                    sourceEnvSelect.innerHTML = '<option value="">æš‚æ— ç¯å¢ƒ</option>';
                    return;
                }
                list.innerHTML = envs.map(env => `
                    <li class="env-item">
                        <div>
                            <div class="env-name">${escapeHtml(env.name)}</div>
                            <div class="env-version">Python ${escapeHtml(env.python_version)}</div>
                        </div>
                        <div class="actions">
                            <button class="btn btn-danger" onclick="deleteEnv('${escapeHtml(env.name)}')">ğŸ—‘ï¸ åˆ é™¤</button>
                        </div>
                    </li>
                `).join('');

                // æ›´æ–°å…‹éš†çš„æºç¯å¢ƒä¸‹æ‹‰æ¡†
                sourceEnvSelect.innerHTML = envs.map(env => `
                    <option value="${escapeHtml(env.name)}">${escapeHtml(env.name)}</option>
                `).join('');
            } catch (err) {
                document.getElementById('envList').innerHTML = `<li style="color:red">âŒ åŠ è½½å¤±è´¥: ${err.message}</li>`;
                document.getElementById('sourceEnv').innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
            }
        }

        // åˆ›å»ºç¯å¢ƒ
        async function createEnv() {
            const name = document.getElementById('envName').value.trim();
            const version = document.getElementById('pythonVersion').value;
            if (!name) {
                alert('è¯·è¾“å…¥ç¯å¢ƒåç§°');
                return;
            }
            if (!/^[a-zA-Z0-9._-]+$/.test(name)) {
                alert('ç¯å¢ƒåç§°åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ç‚¹ã€ä¸‹åˆ’çº¿æˆ–è¿å­—ç¬¦');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/envs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, python_version: version })
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.detail || `HTTP ${res.status}`);
                }
                const data = await res.json();
                addLog(data.message);
                document.getElementById('envName').value = '';
                loadEnvs(); // åˆ·æ–°åˆ—è¡¨
            } catch (err) {
                addLog(`âŒ åˆ›å»ºå¤±è´¥: ${err.message}`, true);
            }
        }

        // å…‹éš†ç¯å¢ƒ
        async function cloneEnv() {
            const sourceEnv = document.getElementById('sourceEnv').value;
            const newEnvName = document.getElementById('newEnvName').value.trim();

            if (!sourceEnv) {
                alert('è¯·é€‰æ‹©æºç¯å¢ƒ');
                return;
            }
            if (!newEnvName) {
                alert('è¯·è¾“å…¥æ–°ç¯å¢ƒåç§°');
                return;
            }
            if (!/^[a-zA-Z0-9._-]+$/.test(newEnvName)) {
                alert('æ–°ç¯å¢ƒåç§°åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ç‚¹ã€ä¸‹åˆ’çº¿æˆ–è¿å­—ç¬¦');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/envs/clone`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source_env: sourceEnv, new_env: newEnvName })
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.detail || `HTTP ${res.status}`);
                }
                const data = await res.json();
                addLog(data.message);
                document.getElementById('newEnvName').value = '';
                loadEnvs(); // åˆ·æ–°åˆ—è¡¨
            } catch (err) {
                addLog(`âŒ å…‹éš†å¤±è´¥: ${err.message}`, true);
            }
        }

        async function exportEnv() {
            const envName = prompt("è¯·è¾“å…¥è¦å¯¼å‡ºçš„ç¯å¢ƒåç§°:");
            if (!envName) return;

            try {
                // æ£€æŸ¥ç¯å¢ƒæ˜¯å¦å­˜åœ¨
                const envCheck = await fetch(`${API_BASE}/envs`);
                const envs = await envCheck.json();
                if (!envs.some(env => env.name === envName)) {
                    alert(`ç¯å¢ƒ "${envName}" ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º`);
                    return;
                }

                // ä½¿ç”¨POSTæ–¹æ³•å‘é€è¯·æ±‚
                const res = await fetch(`${API_BASE}/envs/export`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ env_name: envName })
                });

                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.detail || `HTTP ${res.status}`);
                }

                const data = await res.json();

                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const blob = new Blob([data.yml_content], { type: 'text/yml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${envName}.yml`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                addLog(`âœ… å·²å¯¼å‡ºç¯å¢ƒ "${envName}" ä¸ºYMLæ–‡ä»¶`);
            } catch (err) {
                addLog(`âŒ å¯¼å‡ºå¤±è´¥: ${err.message}`, true);
            }
        }

        // åˆ é™¤ç¯å¢ƒ
        async function deleteEnv(name) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç¯å¢ƒ "${name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼`)) return;
            try {
                const res = await fetch(`${API_BASE}/envs/${encodeURIComponent(name)}`, {
                    method: 'DELETE'
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.detail || `HTTP ${res.status}`);
                }
                const data = await res.json();
                addLog(data.message);
                loadEnvs(); // åˆ·æ–°åˆ—è¡¨
            } catch (err) {
                addLog(`âŒ åˆ é™¤å¤±è´¥: ${err.message}`, true);
            }
        }

        // æ—¥å¿—ç›¸å…³
        function addLog(message, isError = false) {
            const container = document.getElementById('logContainer');
            const div = document.createElement('div');
            div.className = `log-entry${isError ? ' log-error' : ''}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
        }

        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // åˆå§‹åŒ–
        loadEnvs();

        // è½®è¯¢æ—¥å¿—
        setInterval(async () => {
            try {
                const res = await fetch(`${API_BASE}/logs`);
                if (res.ok) {
                    const data = await res.json();
                    const container = document.getElementById('logContainer');
                    const existingText = container.innerText;
                    data.logs.forEach(msg => {
                        if (!existingText.includes(msg)) {
                            addLog(msg, msg.includes('[ERROR]'));
                        }
                    });
                }
            } catch (e) {}
        }, 5000);
    </script>
</body>
</html>